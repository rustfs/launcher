name: Upstream Sync

# å½“ä¸Šæ¸¸ rustfs/rustfs å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶ï¼Œè‡ªåŠ¨è§¦å‘æ„å»º
on:
  # å®šæ—¶æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬ï¼ˆæ¯å¤©UTCæ—¶é—´6ç‚¹ï¼ŒåŒ—äº¬æ—¶é—´14ç‚¹ï¼‰
  schedule:
    - cron: '0 6 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æ„å»ºï¼ˆå³ä½¿ç‰ˆæœ¬æœªå˜åŒ–ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  check-upstream:
    name: æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º tag
    outputs:
      has_new_version: ${{ steps.compare.outputs.has_new_version }}
      upstream_version: ${{ steps.upstream.outputs.version }}
      should_build: ${{ steps.compare.outputs.should_build }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬
        id: upstream
        run: |
          # ä» rustfs/rustfs GitHub Releases è·å–æœ€æ–°ç‰ˆæœ¬ï¼ˆåŒ…æ‹¬ pre-releaseï¼‰
          UPSTREAM_VERSION=$(curl -s https://api.github.com/repos/rustfs/rustfs/releases | jq -r '.[0].tag_name')
          
          if [ -z "$UPSTREAM_VERSION" ] || [ "$UPSTREAM_VERSION" = "null" ]; then
            echo "âŒ æ— æ³•è·å–ä¸Šæ¸¸ç‰ˆæœ¬"
            exit 1
          fi
          
          echo "version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬: $UPSTREAM_VERSION"
      
      - name: è·å–å½“å‰ä»“åº“ç‰ˆæœ¬
        id: current
        run: |
          # ä»æœ€æ–°çš„ git tag è·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
      
      - name: æ¯”è¾ƒç‰ˆæœ¬
        id: compare
        run: |
          UPSTREAM="${{ steps.upstream.outputs.version }}"
          CURRENT="${{ steps.current.outputs.version }}"
          FORCE="${{ github.event.inputs.force_build }}"
          
          echo "ä¸Šæ¸¸ç‰ˆæœ¬: $UPSTREAM"
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT"
          
          if [ "$FORCE" = "true" ]; then
            echo "ğŸ”¨ å¼ºåˆ¶æ„å»ºæ¨¡å¼"
            echo "has_new_version=true" >> $GITHUB_OUTPUT
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [ "$UPSTREAM" != "$CURRENT" ]; then
            echo "ğŸ†• å‘ç°æ–°ç‰ˆæœ¬: $UPSTREAM (å½“å‰: $CURRENT)"
            echo "has_new_version=true" >> $GITHUB_OUTPUT
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            echo "has_new_version=false" >> $GITHUB_OUTPUT
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi
      
      - name: åˆ›å»ºæ–°ç‰ˆæœ¬æ ‡ç­¾
        if: steps.compare.outputs.has_new_version == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UPSTREAM_VERSION="${{ steps.upstream.outputs.version }}"
          
          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$UPSTREAM_VERSION" >/dev/null 2>&1; then
            echo "âš ï¸  æ ‡ç­¾ $UPSTREAM_VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            # åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
            git tag -a "$UPSTREAM_VERSION" -m "Sync with upstream rustfs/rustfs $UPSTREAM_VERSION"
            git push origin "$UPSTREAM_VERSION"
            echo "âœ… å·²åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾: $UPSTREAM_VERSION"
          fi

  trigger-build:
    name: è§¦å‘æ„å»º
    needs: check-upstream
    if: needs.check-upstream.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: è§¦å‘æ„å»ºå·¥ä½œæµ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UPSTREAM_VERSION="${{ needs.check-upstream.outputs.upstream_version }}"
          
          echo "ğŸš€ è§¦å‘æ„å»ºç‰ˆæœ¬: $UPSTREAM_VERSION"
          
          # è§¦å‘ build.yml workflow
          gh workflow run build.yml \
            --ref main \
            -f tag="$UPSTREAM_VERSION"
          
          echo "âœ… æ„å»ºå·¥ä½œæµå·²è§¦å‘"
      
      - name: å‘é€é€šçŸ¥
        if: always()
        run: |
          UPSTREAM_VERSION="${{ needs.check-upstream.outputs.upstream_version }}"
          echo "ğŸ“¢ æ„å»ºé€šçŸ¥ï¼š"
          echo "  - ä¸Šæ¸¸ç‰ˆæœ¬: $UPSTREAM_VERSION"
          echo "  - å·¥ä½œæµçŠ¶æ€: ${{ job.status }}"
          echo "  - ä»“åº“: ${{ github.repository }}"
          echo "  - è¿è¡ŒID: ${{ github.run_id }}"
